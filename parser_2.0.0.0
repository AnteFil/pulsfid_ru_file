import os
import re
import time
import requests
import json
import uuid
from urllib.parse import urlparse, quote_plus
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---

# –ü—É—Ç—å –∫ –≤–∞—à–∏–º —Ñ–∞–π–ª–∞–º
chromedriver_path = "driver\\chromedriver.exe"
chrome_path = "chrome\\chrome.exe"
# –ü–∞–ø–∫–∞ output_folder —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∏–∂–µ

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü Google –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ (1 –∏–ª–∏ 2)
GOOGLE_PAGES_TO_PARSE = 1

# URL –¥–ª—è –ø–æ–∏—Å–∫–∞ (—à–∞–±–ª–æ–Ω)
url_template = "https://www.google.com/search?q={keyword}&tbs=qdr:d&tbm=nws&hl=ru&gl=RU"

# --- –ù–ê–°–¢–†–û–ô–ö–ò API –°–£–ú–ú–ê–†–ò–ó–ê–¶–ò–ò---
API_URL = "https://bbfil.ru/deepseek_sum.php"
API_KEY = "or-v1a01962d55218e043287c3346491"
API_HEADERS = {
    'Content-Type': 'application/json',
    'X-API-Key': API_KEY
}

# --- –ù–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò API ---
API_GET_KEYWORD = "https://pulsfid.ru/api/get/empty/one/keyword"
API_POST_RESULTS = "https://pulsfid.ru/api/add/searches/with-attachments"
TOKEN = "1|rlGA9DvSwMkPYK2uA8wKNx42BssDKk3hoJn4Kd8H0f5e0ead"

# --- –ù–ê–°–¢–†–û–ô–ö–ò OPENROUTER API ---
OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"
OPENROUTER_API_KEY = "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"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∫–ª—é—á API
OPENROUTER_HEADERS = {
    'Content-Type': 'application/json',
    'Authorization': f'Bearer {OPENROUTER_API_KEY}'
}

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
MAX_RETRIES = 3
# –ù–∞—á–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
INITIAL_TIMEOUT = 300  # –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 240 –¥–æ 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)


# --- –§–£–ù–ö–¶–ò–ò ---
def get_keyword_from_api():
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏ UUID –∏–∑ API
    """
    print("\nüì§ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ –∏–∑ API...")

    headers = {
        'Authorization': f'Bearer {TOKEN}'
    }

    try:
        response = requests.get(API_GET_KEYWORD, headers=headers, timeout=30)

        if response.status_code == 200:
            response_data = response.json()
            keyword = response_data.get('title', '')
            keyword_uuid = response_data.get('uuid', '')

            if keyword and keyword_uuid:
                print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: {keyword}")
                print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω UUID: {keyword_uuid}")
                return keyword, keyword_uuid
            else:
                print("‚ùå –í –æ—Ç–≤–µ—Ç–µ API –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è 'title' –∏–ª–∏ 'uuid'")
                return None, None
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {response.status_code}")
            print(f"–û—Ç–≤–µ—Ç: {response.text}")
            return None, None

    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {e}")
        return None, None


def clean_text_for_json(text):
    # –£–¥–∞–ª—è–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ \t, \n, \r
    return ''.join(char for char in text if char.isprintable() or char in '\t\n\r')


def send_request_with_retries(url, payload, headers, max_retries=MAX_RETRIES, initial_timeout=INITIAL_TIMEOUT):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–º—Å—è —Ç–∞–π–º–∞—É—Ç–æ–º
    """
    for attempt in range(max_retries):
        try:
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
            current_timeout = initial_timeout * (attempt + 1)
            print(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}, —Ç–∞–π–º–∞—É—Ç: {current_timeout} —Å–µ–∫—É–Ω–¥")

            response = requests.post(url, json=payload, headers=headers, timeout=current_timeout)
            print(f"–°—Ç–∞—Ç—É—Å-–∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: {response.status_code}")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
            if response.status_code == 200:
                try:
                    return response.json()
                except ValueError as e:
                    print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                    print(f"–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞: {response.text[:500]}...")  # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞
                    if attempt < max_retries - 1:
                        print("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥...")
                        time.sleep(10)
                        continue
                    else:
                        raise
            elif response.status_code in [504, 502, 503]:  # –û—à–∏–±–∫–∏ —à–ª—é–∑–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏
                print(f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ {response.status_code}, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
                if attempt < max_retries - 1:
                    time.sleep(15)  # –ñ–¥–µ–º 15 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
                    continue
                else:
                    raise Exception(f"–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É {response.status_code} –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
            else:
                print(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å-–∫–æ–¥: {response.status_code}")
                print(f"–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞: {response.text[:500]}...")
                raise Exception(f"–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å-–∫–æ–¥ {response.status_code}")

        except requests.exceptions.Timeout:
            print(f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ ({current_timeout} —Å–µ–∫). –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
            if attempt < max_retries - 1:
                time.sleep(10)
                continue
            else:
                raise Exception(f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
        except requests.exceptions.RequestException as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
            if attempt < max_retries - 1:
                time.sleep(10)
                continue
            else:
                raise


def send_to_openrouter(titles_text):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ OpenRouter API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç
    """
    print("\nüì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ OpenRouter API...")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    prompt = f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π –≤–µ—Ä–Ω–∏ –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è—â–∏–π 3-6 —Å–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π –∫ –Ω–æ–≤–æ—Å—Ç–∏. –í—ã–±–µ—Ä–∏ —Ç–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∏–ª—É—á—à–∏–º –æ–±—Ä–∞–∑–æ–º –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–º—É. –ü—Ä–∞–≤–∏–ª–∞:–û—Ç–≤–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–∑–∞ –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø–∏—Å–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –ï—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞, —Å–æ–±—ã—Ç–∏–µ, –ø—Ä–æ–∏—à–µ—Å—Ç–≤–∏–µ, –≥–æ—Ä–æ–¥ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –æ–±—ä–µ–∫—Ç ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏ –µ–≥–æ –∏–º—è –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å. –ù–µ –ø–∏—à–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–¥–Ω–æ—Å–ª–æ–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:  \n\n{titles_text}"

    # –§–æ—Ä–º–∏—Ä—É–µ–º payload –¥–ª—è OpenRouter API
    payload = {
        "model": "z-ai/glm-4.5-air:free",
        "messages": [
            {
                "role": "user",
                "content": prompt
            }
        ]
    }

    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        response = requests.post(OPENROUTER_API_URL, json=payload, headers=OPENROUTER_HEADERS, timeout=120)

        if response.status_code == 200:
            response_data = response.json()
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏
            model_response = response_data['choices'][0]['message']['content']

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ —Ñ–∞–π–ª (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
            output_file = os.path.join(output_folder, "openrouter_analysis.txt")
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(model_response)

            print(f"‚úÖ –û—Ç–≤–µ—Ç –æ—Ç OpenRouter: {model_response}")
            return model_response
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenRouter API: {response.status_code}")
            print(f"–û—Ç–≤–µ—Ç: {response.text}")
            return None

    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenRouter API: {e}")
        return None


def get_file_extension(url, headers):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ URL –∏–ª–∏ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    """
    # 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ URL
    path = urlparse(url).path
    ext = os.path.splitext(path)[1]
    if ext:
        return ext

    # 2. –ï—Å–ª–∏ –≤ URL —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–µ—Ç, —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Content-Type
    content_type = headers.get('Content-Type', '')
    if not content_type:
        return '.jpg'  # –í–æ–∑–≤—Ä–∞—Ç –∫ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

    # –û—á–∏—â–∞–µ–º Content-Type –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "; charset=utf-8")
    mime_type = content_type.split(';')[0].strip().lower()

    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è MIME-—Ç–∏–ø–æ–≤ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
    mime_to_ext = {
        'image/jpeg': '.jpg',
        'image/png': '.png',
        'image/gif': '.gif',
        'image/webp': '.webp',
        'image/svg+xml': '.svg',
        'image/bmp': '.bmp',
        'image/tiff': '.tiff'
    }

    return mime_to_ext.get(mime_type, '.jpg')  # –í–æ–∑–≤—Ä–∞—Ç –∫ .jpg, –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω


def search_and_download_images(search_query):
    """
    –ò—â–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
    """
    # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –Ø–Ω–¥–µ–∫—Å–µ
    yandex_images_url = f"https://yandex.ru/images/search?from=tabbar&text={quote_plus(search_query)}&recent=7D&iorient=horizontal"
    print(f"\nüîç –ü–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É: '{search_query}'")

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—Ü–∏–π Chrome
    chrome_options = Options()
    chrome_options.binary_location = chrome_path
    chrome_options.add_argument("--start-maximized")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_experimental_option('excludeSwitches', ['enable-logging'])

    service = Service(executable_path=chromedriver_path)
    driver = None

    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä–∞–π–≤–µ—Ä–∞
        driver = webdriver.Chrome(service=service, options=chrome_options)
        print("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...")
        driver.get(yandex_images_url)

        # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        print("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏...")
        wait = WebDriverWait(driver, 20)  # –£–≤–µ–ª–∏—á–∏–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ 20 —Å–µ–∫—É–Ω–¥
        # –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä—è–¥–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, 'div.JustifierRowLayout-Row[data-pos="0"]')))
        print("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...")

        # –ü–æ–∏—Å–∫ –≤—Å–µ—Ö —Ç–µ–≥–æ–≤ img —Å –Ω—É–∂–Ω—ã–º –∫–ª–∞—Å—Å–æ–º
        image_elements = driver.find_elements(By.CSS_SELECTOR, 'img.ImagesContentImage-Image')

        if not image_elements:
            print("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.")
            return []

        downloaded_images = []
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        for i, img_element in enumerate(image_elements[:3]):
            try:
                # –ü–æ–ª—É—á–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ 'src'
                img_src = img_element.get_attribute('src')

                # URL –≤ –Ø–Ω–¥–µ–∫—Å–µ —á–∞—Å—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å '//', –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 'https:'
                if img_src and img_src.startswith('//'):
                    img_url = 'https:' + img_src
                else:
                    img_url = img_src

                if not img_url:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i + 1}.")
                    continue

                print(f"–ù–∞–π–¥–µ–Ω URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i + 1}: {img_url}")

                # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                print(f"–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i + 1}...")
                response = requests.get(img_url, stream=True, timeout=10)
                response.raise_for_status()  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ HTTP (4xx –∏–ª–∏ 5xx)

                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø–æ–º–æ—â—å—é –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
                file_extension = get_file_extension(img_url, response.headers)
                print(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ: {file_extension}")

                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å UUID
                filename = f"{uuid.uuid4()}{file_extension}"
                file_path = os.path.join(output_folder, filename)

                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
                with open(file_path, 'wb') as f:
                    for chunk in response.iter_content(chunk_size=8192):
                        f.write(chunk)

                print(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i + 1} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫: {file_path}")
                downloaded_images.append(file_path)

            except requests.exceptions.RequestException as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i + 1}: {e}")
            except Exception as e:
                print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i + 1}: {e}")

        return downloaded_images

    except TimeoutException:
        print("–û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –∑–∞ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.")
        return []
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ–±—â–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {e}")
        return []
    finally:
        # –ó–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        if driver:
            print("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞.")
            driver.quit()


def process_search_results_page(driver, page_number, titles_list, summaries_list):
    """
    –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–∞–º,
    –æ—á–∏—â–∞–µ—Ç –∏—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ API –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–ø–∏—Å–æ–∫.
    –¢–∞–∫–∂–µ —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫.
    """
    print(f"\n===== –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò –°–¢–†–ê–ù–ò–¶–´ {page_number} =====")

    # –î–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—Ä–µ–º—è –Ω–∞ –ø–æ–ª–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    time.sleep(3)

    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±–ª–æ–∫–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    search_results = driver.find_elements(By.CSS_SELECTOR, "div.SoaBEf")

    if not search_results:
        print(f"–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ {page_number} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–µ–∫—É—â–µ–π (–æ—Å–Ω–æ–≤–Ω–æ–π) –≤–∫–ª–∞–¥–∫–∏
    original_window = driver.current_window_handle

    for i, result in enumerate(search_results):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ finally
        source = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π_–∏—Å—Ç–æ—á–Ω–∏–∫"
        link = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è_—Å—Å—ã–ª–∫–∞"

        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            title_element = result.find_element(By.CSS_SELECTOR, "div.n0jPhd.ynAwRc.MBeuO.nDgy9d")
            title = title_element.text

            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å–ø–∏—Å–æ–∫
            titles_list.append(title)

            link_element = result.find_element(By.CSS_SELECTOR, "a.WlydOe")
            link = link_element.get_attribute("href")

            source_element = result.find_element(By.CSS_SELECTOR, "div.MgUUmf.NUnG9d span")
            source = source_element.text

            print(f"\n--- –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page_number} | –†–µ–∑—É–ª—å—Ç–∞—Ç {i + 1}/{len(search_results)}: {source} ---")
            print(f"–ó–∞–≥–æ–ª–æ–≤–æ–∫: {title}")
            print(f"–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ: {link}")

            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            driver.switch_to.new_window('tab')
            driver.get(link)

            # --- –û—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
            js_script = """
                var elements_to_remove = document.querySelectorAll('script, img, a, button, input, footer');
                for (var i = elements_to_remove.length - 1; i >= 0; i--) {
                    elements_to_remove[i].parentNode.removeChild(elements_to_remove[i]);
                }
            """
            driver.execute_script(js_script)
            print("‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.")

            # --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
            body_element = driver.find_element(By.TAG_NAME, 'body')
            cleaned_html = body_element.get_attribute('innerHTML')
            cleaned_text = body_element.text

            if not cleaned_text.strip():
                print("‚ö†Ô∏è –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –Ω–∞–π–¥–µ–Ω —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")
                continue

            # --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–£–¢–ï–ô –ö –§–ê–ô–õ–ê–ú (–î–ï–õ–ê–ï–ú –≠–¢–û –ó–î–ï–°–¨) ---
            base_name = re.sub(r'[\\/*?:"<>|]', "", source)
            html_filepath = os.path.join(output_folder, f"{base_name}.html")
            # –ù–û–í–û–ï: –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å –¥–ª—è —Ñ–∞–π–ª–∞ —Å –∏—Å—Ö–æ–¥–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
            original_txt_filepath = os.path.join(output_folder, f"{base_name}_original.txt")

            # --- –°–†–ê–ó–£ –°–û–•–†–ê–ù–Ø–ï–ú HTML-–§–ê–ô–õ ---
            with open(html_filepath, 'w', encoding='utf-8') as f:
                f.write(cleaned_html)
            print(f"‚úÖ –û—á–∏—â–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (HTML) —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª: {html_filepath}")

            # --- –ù–û–í–û–ï: –°–û–•–†–ê–ù–Ø–ï–ú –ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢ ---
            with open(original_txt_filepath, 'w', encoding='utf-8') as f:
                f.write(cleaned_text)
            print(f"‚úÖ –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {original_txt_filepath}")

            # --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ API –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ ---
            try:
                print("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ API –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏...")

                # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                cleaned_text_for_api = clean_text_for_json(cleaned_text)
                payload = {'content': cleaned_text_for_api}

                print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ {API_URL} –º–µ—Ç–æ–¥–æ–º POST")
                # –ù–µ –≤—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π payload –≤ –∫–æ–Ω—Å–æ–ª—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º
                print(f"–î–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {len(str(payload))} —Å–∏–º–≤–æ–ª–æ–≤")

                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
                response_data = send_request_with_retries(API_URL, payload, API_HEADERS)
                print("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç API —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω.")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –æ—à–∏–±–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç –Ω–∞—à–µ–≥–æ PHP-–ø—Ä–æ–∫—Å–∏
                if 'error' in response_data:
                    error_message = response_data['error']
                    print(f"‚ùå API –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É: {error_message}")
                    summary_text = f"–û—à–∏–±–∫–∞ API: {error_message}"
                else:
                    # –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ –Ω–µ—Ç, –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç
                    try:
                        summary_text = response_data['message']['content']
                    except (KeyError, TypeError):
                        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å 'content' –∏–∑ –æ—Ç–≤–µ—Ç–∞ API. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.")
                        summary_text = "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–æ–Ω—Ç–µ–Ω—Ç. –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:\n" + str(response_data)

                # --- –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Å–ø–∏—Å–æ–∫ ---
                summaries_list.append(summary_text)
                print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫. –í—Å–µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ: {len(summaries_list)}")

            except Exception as e:
                print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ API: {e}")
                # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ –≤ —Å–ø–∏—Å–æ–∫
                summaries_list.append(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏/API: {e}")

        except TimeoutException:
            print(f"‚è∞ –°–∞–π—Ç {link} –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ 10 —Å–µ–∫—É–Ω–¥. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")
        except Exception as e:
            print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å—Å—ã–ª–∫–∏ {link}: {e}")
        finally:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é
            if len(driver.window_handles) > 1:
                driver.close()
            driver.switch_to.window(original_window)
            time.sleep(1)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

    print(f"\n===== –ó–ê–í–ï–†–®–ï–ù–ê –û–ë–†–ê–ë–û–¢–ö–ê –°–¢–†–ê–ù–ò–¶–´ {page_number} =====")


def post_results_to_api(keyword, keyword_uuid, summaries_list, downloaded_images):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–∞ API –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π
    """
    print("\nüì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ API...")

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ –æ–¥–∏–Ω –±–ª–æ–∫
    combined_text = "\n\n".join(summaries_list)

    # --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô ---

    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
    if not combined_text.strip():
        print("‚ùå –¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—Å—Ç. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return False

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ (–±–æ–ª–µ–µ 300 —Å–∏–º–≤–æ–ª–æ–≤)
    if len(combined_text) <= 300:
        print(f"‚ùå –¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π ({len(combined_text)} —Å–∏–º–≤–æ–ª–æ–≤). –¢—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª–µ–µ 300 —Å–∏–º–≤–æ–ª–æ–≤. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return False

    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–±–æ–ª–µ–µ 1)
    if len(downloaded_images) < 1:
        print(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ({len(downloaded_images)} —à—Ç.). –¢—Ä–µ–±—É–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return False

    print("‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞. –¢–µ–∫—Å—Ç > 300 —Å–∏–º–≤–æ–ª–æ–≤, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è >= 1. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É.")

    # --- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–æ 16000 —Å–∏–º–≤–æ–ª–æ–≤ ---
    if len(combined_text) > 16000:
        print(f"‚ö†Ô∏è –¢–µ–∫—Å—Ç –ø—Ä–µ–≤—ã—à–∞–µ—Ç 16000 —Å–∏–º–≤–æ–ª–æ–≤ ({len(combined_text)}). –û–±—Ä–µ–∑–∞–µ–º.")
        # –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–µ–∑–∫–∞ –¥–æ 16000 —Å–∏–º–≤–æ–ª–æ–≤
        combined_text = combined_text[:16000]
        print(f"‚úÖ –¢–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–æ {len(combined_text)} —Å–∏–º–≤–æ–ª–æ–≤.")

    headers = {
        'Authorization': f'Bearer {TOKEN}'
    }

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    data = {
        'keyword_uuid': keyword_uuid,
        'title': keyword,
        'text': combined_text
    }

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    files = {}

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    for i, img_path in enumerate(downloaded_images):
        if os.path.exists(img_path):
            files[f'attachments[{i}]'] = (os.path.basename(img_path), open(img_path, 'rb'), 'image/jpeg')
        else:
            print(f"‚ö†Ô∏è –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: {img_path}")

    try:
        print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ {API_POST_RESULTS}...")
        print(f"–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(combined_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {len(downloaded_images)}")

        response = requests.post(API_POST_RESULTS, data=data, files=files, headers=headers, timeout=120)

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
        for file_obj in files.values():
            if hasattr(file_obj[1], 'close'):
                file_obj[1].close()

        if response.status_code == 200 or response.status_code == 201:
            response_data = response.json()
            print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ API")
            print(f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response_data}")
            return True
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ API: {response.status_code}")
            print(f"–û—Ç–≤–µ—Ç: {response.text}")
            return False

    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ API: {e}")
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã –≤ —Å–ª—É—á–∞–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        for file_obj in files.values():
            if hasattr(file_obj[1], 'close'):
                file_obj[1].close()
        return False


# --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---

# –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏ UUID –∏–∑ API
keyword, keyword_uuid = get_keyword_from_api()

if not keyword or not keyword_uuid:
    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ UUID. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—É.")
    exit(1)

# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É —Å –∏–º–µ–Ω–µ–º UUID ---
output_folder = keyword_uuid
os.makedirs(output_folder, exist_ok=True)
print(f"üìÅ –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤: {output_folder}")

# –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º
search_url = url_template.format(keyword=quote_plus(keyword))
print(f"üîç URL –¥–ª—è –ø–æ–∏—Å–∫–∞: {search_url}")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—Ü–∏–π Chrome
chrome_options = Options()
chrome_options.add_argument("--start-maximized")
chrome_options.binary_location = chrome_path

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∏ –∑–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞
service = Service(executable_path=chromedriver_path)
driver = webdriver.Chrome(service=service, options=chrome_options)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º-–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ 20 —Å–µ–∫—É–Ω–¥
driver.set_page_load_timeout(20)

# –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
titles_list = []
summaries_list = []
downloaded_images = []

try:
    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü ---
    driver.get(search_url)
    process_search_results_page(driver, page_number=1, titles_list=titles_list, summaries_list=summaries_list)

    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ ---
    for page_num in range(2, GOOGLE_PAGES_TO_PARSE + 1):
        try:
            print(f"\n–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã {page_num}...")
            # –ò—â–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            page_link_element = driver.find_element(By.CSS_SELECTOR, f'a[aria-label="Page {page_num}"]')

            if page_link_element:
                print(f"–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É {page_num} –Ω–∞–π–¥–µ–Ω–∞. –ü–µ—Ä–µ—Ö–æ–¥...")
                page_link_element.click()

                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                process_search_results_page(driver, page_number=page_num, titles_list=titles_list, summaries_list=summaries_list)
            else:
                print(f"–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É {page_num} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –ø–æ–∏—Å–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.")
                break

        except NoSuchElementException:
            print(f"–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É {page_num} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –ø–æ–∏—Å–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.")
            break

    # --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª ---
    if summaries_list:
        print(f"\n–í—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏: {len(summaries_list)}")

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ –æ–¥–∏–Ω –±–ª–æ–∫
        combined_text = "\n\n".join(summaries_list)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Ñ–∞–π–ª
        summaries_file = os.path.join(output_folder, "all_summaries.json")
        with open(summaries_file, 'w', encoding='utf-8') as f:
            json.dump({"text": combined_text}, f, ensure_ascii=False, indent=2)
        print(f"‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {summaries_file}")

    # --- –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ OpenRouter ---
    if titles_list:
        print(f"\n–í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: {len(titles_list)}")

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç
        titles_text = "\n".join(titles_list)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ OpenRouter API –∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        search_query = send_to_openrouter(titles_text)

        # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∏—â–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if search_query:
            # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–≥–æ
            time.sleep(3)

            # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –±—Ä–∞—É–∑–µ—Ä
            driver.quit()

            # –ò—â–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            downloaded_images = search_and_download_images(search_query)

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
            if downloaded_images:
                images_info_file = os.path.join(output_folder, "downloaded_images.txt")
                with open(images_info_file, 'w', encoding='utf-8') as f:
                    f.write(f"–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: {search_query}\n\n")
                    for i, img_path in enumerate(downloaded_images, 1):
                        f.write(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i}: {img_path}\n")
                print(f"‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª: {images_info_file}")
        else:
            print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç OpenRouter.")
    else:
        print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ OpenRouter.")

    # --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ API ---
    if summaries_list:
        post_results_to_api(keyword, keyword_uuid, summaries_list, downloaded_images)

except Exception as e:
    print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ–±—â–∞—è –æ—à–∏–±–∫–∞: {e}")
finally:
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã (–µ—Å–ª–∏ –æ–Ω –µ—â–µ –æ—Ç–∫—Ä—ã—Ç)
    try:
        if driver:
            print("\n–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ë—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.")
            driver.quit()
    except:
        pass
